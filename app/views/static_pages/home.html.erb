<section>
  <div class="container" id="home_element">
    <div class="row">
      <div class="col-md-8">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">Wall</h3>
          </div>
          <div class="panel-body">
            <%= form_for :new_photo, url: photos_create_path(@new_photo) do |f| %>
              <div class="form-group">
                <%= f.label :title %>
                <%= f.text_field :title, class: "form-control" %>
              </div>
              <div class="form-group">
                <%= f.label :description %>
                <%= f.text_area :description, class: "form-control" %>
              </div>
              <%= f.submit "Submit", class: "btn btn-default" %>
              <div class="pull-right">
                <div class="btn-toolbar">
                  <%= f.file_field :location, accept: 'image/png,image/gif,image/jpeg' %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
        <div v-for="(photo, index) in photos" class="panel panel-default post" id="home-element">
          <div class="panel-body">
            <div class="row">
              <div class="col-sm-2">
                <a href="profile.html"
                   class="post-avatar thumbnail">
                  <%= image_tag("user.png") %>
                  <div class="text-center">{{photo.user_email}}</div>
                </a>
              </div>
              <div class="col-sm-10">
                <div class="pointer text-center">
                  <img v-bind:src="photo.location" v-bind:alt="photo.title">
                </div>
                <div class="pointer-border">
                  <h4 class="text-center">
                    {{photo.title}}
                  </h4>
                  <p>
                    {{photo.description}}
                  </p>
                </div>
                <p class="post-actions">
                  <star-rating v-bind:increment="0.1" v-bind:max-rating="5"
                               inactive-color="#000" active-color="yellow" v-bind:star-size="20"
                               v-bind:rating="photo.photo_score"
                               @rating-selected="setRating($event, index)">
                  </star-rating>
                  <i v-if="photo.loading" class="fas fa-circle-notch fa-spin"></i>
                </p>

                <div class="comments">
                  <div v-for="comment in photo.comments">
                    <div class="comment">
                      <a href="#" class="comment-avatar pull-left"><%= image_tag("user.png") %></a>
                      <div class="comment-text">
                        <p>{{comment.content}}</p>
                      </div>
                    </div>
                    <div class="clearfix"></div>
                  </div>
                </div>

                <div class="clearfix"></div>

                <form>
                  <div class="input-group">
                    <input type="text" class="form-control" name="email" placeholder="Your comments" v-model="photo.comment_content">
                    <span class="input-group-addon" v-on:click="comment(index)"><i class="fas fa-paper-plane"></i></span>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="panel panel-default friends">
          <div class="panel-heading">
            <h3 class="panel-title">My Friends</h3>
          </div>
          <div class="panel-body">
            <div class="clearfix"></div>
            <a class="btn btn-primary" href="#">View All Friends</a>
          </div>
        </div>
        <div class="panel panel-default groups">
          <div class="panel-heading">
            <h3 class="panel-title">Latest Groups</h3>
          </div>
          <div class="panel-body">
            <div class="group-item">
              <!--              <img src="images/group.png" alt="">-->
              <h4><a href="#" class="">Sample Group One</a></h4>
              <p>This is a paragraph of intro text, or whatever I
                want to call it.</p>
            </div>
            <div class="clearfix"></div>
            <div class="group-item">
              <!--              <img src="images/group.png" alt="">-->
              <h4><a href="#" class="">Sample Group Two</a></h4>
              <p>This is a paragraph of intro text, or whatever I
                want to call it.</p>
            </div>
            <div class="clearfix"></div>
            <div class="group-item">
              <!--              <img src="images/group.png" alt="">-->
              <h4><a href="#" class="">Sample Group Three</a></h4>
              <p>This is a paragraph of intro text, or whatever I
                want to call it.</p>
            </div>
            <div class="clearfix"></div>
            <a href="#" class="btn btn-primary">View All Groups</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<script type="text/javascript" charset="utf-8">
  $(document).ready(f => {
    let home = new Vue({
      el: '#home_element',
      data: {
        rating: 3,
        photos: []
      },
      methods: {
        setRating: function (rating, index) {
          let self = this;
          let photo_id = self.photos[index].id;
          rating = Math.ceil(rating)
          self.photos[index].loading = true;
          $.post("/vote", {photo_id, rating}).done(function (respone) {
            self.photos[index].photo_score = parseInt(respone)
            self.photos[index].loading = false;
            console.log(respone)
          }).error(er => {
            console.log(er)
          })
        },
        comment: function (index) {
          let self = this;
          let photo_id = self.photos[index].id;
          let content = self.photos[index].comment_content;
          self.photos[index].comment_content = "";
          $.post("/comments", {
            comment: {
              photo_id,
              content
            }
          }).done(function (response) {
            if (response.code == 1) {
              self.photos[index].comments.push({content: content})
            } else {
              alert(response.message)
            }
          }).error(err => {
            console.log(err)
          })
        },
        photos_get: function (query, pages, limit) {
          let self = this;
          if (!pages) pages = 0;
          if (!limit) limit = 6;
          if (!query) query = null;
          $.get("/photos", {photos: {pages, limit, query}}).done(respose => {
            self.photos = respose.map(f => {
              f.loading = false;
              f.comment_content = "";
              return f
            })
          }).error(er => {

          })
        },
      },
      computed: {},
      mounted() {
        this.photos = this.photos_get()
      }
    });
  })
</script>
